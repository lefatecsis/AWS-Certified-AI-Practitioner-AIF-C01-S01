<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulado AWS AI Practitioner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .explicacao-hidden {
      display: none;
    }

    /* Efeitos para respostas corretas e incorretas */
    .list-group-item.list-group-item-success {
      background-color: #d4edda !important;
      color: #155724 !important;
      border-color: #c3e6cb !important;
      transition: all 0.3s ease;
    }

    .list-group-item.list-group-item-danger {
      background-color: #f8d7da !important;
      color: #721c24 !important;
      border-color: #f5c6cb !important;
    }

    /* Estilo alternativo mais específico */
    .resposta-correta {
      background-color: #28a745 !important;
      color: white !important;
      border-color: #28a745 !important;
    }

    /* Contador flutuante */
    .contador-flutuante {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 80px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container my-5">
    <div class="text-center mb-4">
      <h1 class="display-5">Simulado AWS AI Practitioner</h1>
      <p class="lead">Questões do exame AIF-C01 (Traduzidas)</p>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
      <button class="btn btn-primary me-md-2" id="expandirTodos" type="button">Expandir Todas</button>
      <button class="btn btn-secondary" id="recolherTodos" type="button">Recolher Todas</button>
    </div>

    <div class="accordion" id="quizAccordion">
      <!-- Questões serão inseridas aqui dinamicamente -->
    </div>

    <!-- Contador flutuante -->
    <div class="contador-flutuante" id="contadorPontuacao">
      0/0
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // Função para buscar questões da API
      async function fetchQuestoes() {
        try {
          const response = await fetch('https://xycawmzzmqmjeuqwhxva.supabase.co/rest/v1/questoes_aws_ai?select=*&order=numero_questao.asc&apikey=sb_publishable_BnAyJzAgHp9ebQ9f9G63pg_kXygu9Ex');
          const questoes = await response.json();
          return questoes;
        } catch (error) {
          console.error('Erro ao buscar questões:', error);
          return [];
        }
      }

      // Função para gerar HTML de uma questão
      function generateQuestionHTML(questao) {
        const correctKey = String(questao.resposta_correta || '').trim().toUpperCase();

        // Verifica se opcoes é array ou objeto
        let options;
        if (Array.isArray(questao.opcoes)) {
          // Se for array, cada item já tem a letra no início (ex: "A. texto")
          options = questao.opcoes.map((opcaoCompleta, index) => {
            // Extrai a letra do início da string (ex: "A. texto" -> "A")
            const letra = opcaoCompleta.charAt(0).toUpperCase();
            const isCorrect = letra === correctKey;
            return `
              <label class="d-flex align-items-center mb-0 form-check list-group-item" data-correct="${isCorrect ? 'true' : 'false'}" data-option="${letra}">
                <input class="form-check-input me-2" name="q_${questao.numero_questao}" type="radio" value="${letra}" data-option="${letra}" />
                <span>${opcaoCompleta}</span>
              </label>
            `;
          }).join('');
        } else {
          // Se for objeto, usa a lógica original
          options = Object.entries(questao.opcoes || {}).map(([letra, texto]) => {
            const key = String(letra || '').trim().toUpperCase();
            const isCorrect = key === correctKey;
            return `
              <label class="d-flex align-items-center mb-0 form-check list-group-item" data-correct="${isCorrect ? 'true' : 'false'}" data-option="${key}">
                <input class="form-check-input me-2" name="q_${questao.numero_questao}" type="radio" value="${key}" data-option="${key}" />
                <span>${key}. ${texto}</span>
              </label>
            `;
          }).join('');
        }

        return `
          <div class="card mb-3 question-card">
            <div class="card-header" id="heading${questao.numero_questao}">
              <h2 class="mb-0">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapse${questao.numero_questao}">
                  Questão ${questao.numero_questao}
                </button>
              </h2>
            </div>
            <div id="collapse${questao.numero_questao}" class="collapse" data-bs-parent="#quizAccordion">
              <div class="card-body">
                <p class="mb-3">${questao.pergunta}</p>
                <div class="list-group mb-3">
                  ${options}
                </div>
                <p class="resposta-correta-paragraph explicacao-hidden"><strong>Resposta Correta:</strong> ${correctKey}</p>
                <h6 class="explicacao-hidden">Explicação:</h6>
                <p class="explicacao-hidden">${questao.explicacao}</p>
              </div>
            </div>
          </div>
        `;
      }
      // Carregar e renderizar questões
      const questoes = await fetchQuestoes();
      const quizAccordion = document.getElementById('quizAccordion');
      quizAccordion.innerHTML = questoes.map(questao => generateQuestionHTML(questao)).join('');

      // Variáveis para controle de pontuação
      let acertos = 0;
      let totalRespondidas = 0;
      const totalQuestoes = questoes.length;
      const contadorElement = document.getElementById('contadorPontuacao');

      // Função para atualizar contador
      function atualizarContador() {
        contadorElement.textContent = `${acertos}/${totalQuestoes}`;
      }

      // Inicializa contador
      atualizarContador();

      // Expandir/Recolher todas as questões
      document.getElementById('expandirTodos').addEventListener('click', () => {
        document.querySelectorAll('.collapse').forEach(item => {
          const collapse = new bootstrap.Collapse(item, { toggle: false });
          collapse.show();
        });
      });

      document.getElementById('recolherTodos').addEventListener('click', () => {
        document.querySelectorAll('.collapse').forEach(item => {
          const collapse = new bootstrap.Collapse(item, { toggle: false });
          collapse.hide();
        });
      });

      // Listener para respostas - sempre mostra a correta em verde
      quizAccordion.addEventListener('change', function (e) {
        if (e.target.type === 'radio') {
          const questionCard = e.target.closest('.question-card');
          if (!questionCard) return;

          // Verifica se esta questão já foi respondida antes
          const jaRespondida = questionCard.hasAttribute('data-respondida');

          // Remove classes anteriores de todas as opções
          const allLabels = questionCard.querySelectorAll('.list-group-item');
          allLabels.forEach(l => {
            l.classList.remove('list-group-item-success', 'list-group-item-danger', 'resposta-correta', 'bg-success', 'bg-danger', 'text-white');
          });

          // Sempre pinta a resposta correta de verde
          const correctLabel = questionCard.querySelector('.list-group-item[data-correct="true"]');
          if (correctLabel) {
            correctLabel.classList.add('bg-success', 'text-white');
          }

          // Verifica se a resposta selecionada está correta
          const selectedLabel = e.target.closest('.list-group-item');
          const acertou = selectedLabel && selectedLabel.getAttribute('data-correct') === 'true';

          // Se errou, pinta a selecionada de vermelho (além da correta em verde)
          if (!acertou && selectedLabel) {
            selectedLabel.classList.add('bg-danger', 'text-white');
          }

          // Atualiza contador apenas se não foi respondida antes
          if (!jaRespondida) {
            if (acertou) {
              acertos++;
            }
            totalRespondidas++;
            questionCard.setAttribute('data-respondida', 'true');
            questionCard.setAttribute('data-acertou', acertou ? 'true' : 'false');
            atualizarContador();
          } else {
            // Se já foi respondida, ajusta o contador baseado na nova resposta
            const acertouAntes = questionCard.getAttribute('data-acertou') === 'true';
            if (acertouAntes && !acertou) {
              acertos--; // Estava certo, agora errou
            } else if (!acertouAntes && acertou) {
              acertos++; // Estava errado, agora acertou
            }
            questionCard.setAttribute('data-acertou', acertou ? 'true' : 'false');
            atualizarContador();
          }

          // Mostra a explicação
          const explanationElements = questionCard.querySelectorAll('.explicacao-hidden');
          explanationElements.forEach(el => el.classList.remove('explicacao-hidden'));
        }
      });
    });
  </script>
</body>

</html>